<?php
/**
 * 简约不简单，人人都可以是设计师
 * @package Design
 * @author YOLEN
 * @version 1.0
 * @link https://yolen.cn
 */
?>
<?php if (!defined('__TYPECHO_ROOT_DIR__')) exit; $this->need('header.php'); ?>
<?php
$sticky = $this->options->sticky; //置顶的文章cid，按照排序输入, 请以半角逗号或空格分隔
if($sticky && $this->is('index') || $this->is('front')){
    $sticky_cids = explode(',', strtr($sticky, ' ', ','));//分割文本 
    $sticky_html = "<span class='post-top'><svg t='1607672933871' class='icon' viewBox='0 0 2560 1024' version='1.1' xmlns='http://www.w3.org/2000/svg' p-id='1537' width='200' height='200'><path d='M341.333333 56.888889h2161.777778a455.111111 455.111111 0 0 1-455.111111 455.111111H796.444444a455.111111 455.111111 0 0 1-455.111111-455.111111z' fill='#FFEDDF' p-id='1538'></path><path d='M440.888889 56.888889A99.555556 99.555556 0 0 0 341.333333 156.444444v67.527112a227.555556 227.555556 0 0 1-97.166222 186.481777L98.986667 512l145.180444 101.546667A227.555556 227.555556 0 0 1 341.333333 800.028444v67.527112c0 54.954667 44.600889 99.555556 99.555556 99.555555H2389.333333a113.777778 113.777778 0 0 0 113.777778-113.777778V170.666667a113.777778 113.777778 0 0 0-113.777778-113.777778H440.888889z m0-56.888889H2389.333333a170.666667 170.666667 0 0 1 170.666667 170.666667v682.666666a170.666667 170.666667 0 0 1-170.666667 170.666667H440.888889A156.444444 156.444444 0 0 1 284.444444 867.555556v-67.527112a170.666667 170.666667 0 0 0-72.817777-139.889777L66.332444 558.648889a56.888889 56.888889 0 0 1 0-93.297778l145.180445-101.489778A170.666667 170.666667 0 0 0 284.444444 223.971556V156.444444A156.444444 156.444444 0 0 1 440.888889 0z' fill='#FF7200' p-id='1539'></path><path d='M785.976889 370.232889H1046.755556l3.413333-32.085333h-221.184V202.296889h503.808v135.850667H1115.022222l-3.413333 32.085333h264.192v48.469333h-272.384l-6.826667 30.72h195.242667v297.642667H1388.088889v50.517333H773.688889v-50.517333h96.256V449.422222h163.157333l6.144-30.72h-253.269333v-48.469333z m148.138667 376.832h293.546666v-36.181333h-293.546666v36.181333z m0-74.410667h293.546666v-34.133333h-293.546666v34.133333z m0-73.045333h293.546666v-34.133333h-293.546666v34.133333z m0-73.045333h293.546666v-33.450667h-293.546666v33.450667z m337.237333-232.789334v-44.373333h-86.016v44.373333h86.016z m-144.042667 0v-44.373333h-92.842666v44.373333h92.842666z m-150.869333 0v-44.373333h-86.016v44.373333h86.016zM1719.182222 203.662222h349.525334v62.805334H1923.982222c-2.275556 18.204444-5.006222 37.546667-8.192 58.026666h134.485334v330.410667h-63.488V383.886222H1797.688889v271.701334h-63.488v-331.093334h116.053333c3.640889-25.486222 6.144-44.828444 7.509334-58.026666H1719.182222V203.662222z m234.837334 448.512c50.517333 38.229333 91.249778 74.865778 122.197333 109.909334l-47.104 47.104c-27.761778-34.588444-67.584-72.817778-119.466667-114.688l44.373334-42.325334z m-96.256-234.837333h63.488V538.168889c-2.730667 72.362667-21.390222 130.616889-55.978667 174.762667-34.133333 40.504889-89.201778 71.907556-165.205333 94.208l-34.816-55.296c73.272889-20.935111 122.88-47.559111 148.821333-79.872 26.396444-34.588444 40.96-79.189333 43.690667-133.802667V417.336889z m-376.149334 382.293333l-14.336-61.44c23.210667 2.730667 45.511111 4.096 66.901334 4.096 15.473778 0 23.210667-9.557333 23.210666-28.672v-447.146666h-99.669333V203.662222h241.664v62.805334h-76.458667v463.530666c0 46.421333-22.072889 69.632-66.218666 69.632h-75.093334z' fill='#FF7200' p-id='1540'></path></svg></span>"; //置顶标题的 html
    $db = Typecho_Db::get();
    $pageSize = $this->options->pageSize;
    $select1 = $this->select()->where('type = ?', 'post');
    $select2 = $this->select()->where('type = ? && status = ? && created < ?', 'post','publish',time());
    //清空原有文章的列队
    $this->row = [];
    $this->stack = [];
    $this->length = 0;
    $order = '';
    foreach($sticky_cids as $i => $cid) {
        if($i == 0) $select1->where('cid = ?', $cid);
        else $select1->orWhere('cid = ?', $cid);
        $order .= " when $cid then $i";
        $select2->where('table.contents.cid != ?', $cid); //避免重复
    }
    if ($order) $select1->order(null,"(case cid$order end)"); //置顶文章的顺序 按 $sticky 中 文章ID顺序
    if ($this->_currentPage == 1) foreach($db->fetchAll($select1) as $sticky_post){ //首页第一页才显示
        $sticky_post['sticky'] = $sticky_html;
        $this->push($sticky_post); //压入列队
    }
$uid = $this->user->uid; //登录时，显示用户各自的私密文章
    if($uid) $select2->orWhere('authorId = ? && status = ?',$uid,'private');
    $sticky_posts = $db->fetchAll($select2->order('table.contents.created', Typecho_Db::SORT_DESC)->page($this->_currentPage, $this->parameter->pageSize));
    foreach($sticky_posts as $sticky_post) $this->push($sticky_post); //压入列队
    $this->setTotal($this->getTotal()-count($sticky_cids)); //置顶文章不计算在所有文章内
}	?>
<div class="autopagerize_page_element">
  <div class="content">
  <?php while($this->next()): ?>
    <div class="post animated fadeInDown">
      <div class="post_title">
        <h2><a href="<?php $this->permalink() ?>" ><?php if (isset($this->fields->title)): ?><?php  $this->fields->title(); $this->sticky() ?><?php else: ?><?php $this->title(); $this->sticky() ?><?php endif; ?></a>
        </h2>
      </div>
      <div class="list">
        <div class="index_content">
          <p class="list-exc"><?php $this->excerpt(80,'...'); ?></p>
          <div class="list-thumb" style="background-image:url(<?php  $imgurl = $this->fields->imgurl;if($imgurl != ''){echo $imgurl;}else{$this->options->defaultPostIMG();}?>)"></div>
        </div>
      </div>
      <div class="post_footer">
        <div class="meta">
          <div class="info">
            <span class="field">
            <span class="date"><svg t="1607602897409" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2042" width="200" height="200"><path d="M176.937 147.034c6.933-54.037 29.152-79.667 68.183-81.046 42.736-1.509 64.841 21.767 75.308 80.622 127.59 0 255.481 0 376.951 0 14.576-24.866 24.551-49.271 41.281-67.465 9.044-9.834 29.639-12.442 45.002-12.391 37.193 0.129 56.966 25.212 65.844 81.516 10.855 0 22.436-0.151 34.003 0.025 49.523 0.762 76.35 26.671 76.58 76.274 0.519 112.881 0.185 225.767 0.19 338.655 0 104.333 0.141 208.665-0.061 313.001-0.115 60.164-23.918 83.858-83.837 83.867-241.159 0.061-482.323 0.061-723.489 0.006-63.267-0.015-86.934-23.483-86.945-86.169-0.050-212.941-0.035-425.883-0.007-638.827 0.007-62.435 23.869-86.221 86.799-86.892 7.554-0.080 15.097-0.718 24.201-1.177zM120.287 394.786c0 12.784 0 21.23 0 29.676 0 148.753-0.025 297.503 0.021 446.257 0.007 33.282 0.972 34.229 34.801 34.229 238.54 0.041 477.085 0.041 715.629 0.007 34.661-0.007 36.020-1.248 36.039-36.1 0.091-147.901-0.571-295.812 0.622-443.705 0.205-25.493-8.031-30.959-32.039-30.876-241.105 0.837-482.217 0.509-723.329 0.509-9.214 0-18.436 0-31.744 0zM733.959 196.631c0.115 0 0.231 0.003 0.352 0.003 0 21.3-1.465 42.729 0.371 63.869 2.245 25.814 20.419 41.929 43.308 41.772 23.858-0.163 42.028-18.033 42.704-44.986 0.997-40.039 0.912-80.131 0.091-120.178-0.553-26.734-18.266-44.567-42.49-45.45-23.343-0.85-42.465 17.152-44.084 43.618-1.253 20.379-0.252 40.895-0.252 61.351zM204.681 194.401c0.119 0 0.229 0 0.351 0 0 22.165-1.413 44.442 0.371 66.462 2.025 25.063 21.212 41.781 43.798 41.427 23.127-0.364 41.453-17.057 42.274-42.729 1.343-41.735 1.333-83.577-0.030-125.309-0.827-25.17-19.78-42.282-42.621-42.646-23.542-0.374-42.555 17.907-43.934 43.971-1.041 19.557-0.21 39.213-0.21 58.825zM226.103 815.255c0-20.989 0-39.568 0-59.924 41.613 0 82.213 0 124.723 0 0 19.002 0 38.226 0 59.924-40.425 0-81.586 0-124.723 0zM452.183 815.857c0-20.729 0-39.971 0-60.758 41.683 0 82.063 0 123.835 0 0 20.652 0 39.785 0 60.758-41.915 0-82.364 0-123.835 0zM676.985 815.968c0-22.493 0-40.922 0-60.867 40.403 0 79.319 0 120.332 0 0 19.574 0 39.423 0 60.867-39.739 0-79.391 0-120.332 0zM351.625 498.885c0 19.917 0 38.276 0 58.389-41.483 0-81.923 0-124.478 0 0-18.841 0-37.791 0-58.389 40.639 0 81.13 0 124.478 0zM452.333 557.040c0-20.505 0-38.823 0-58.31 41.743 0 82.033 0 123.735 0 0 19.729 0 38.017 0 58.31-41.121 0-81.356 0-123.735 0zM226.505 685.41c0-19.719 0-38.009 0-57.676 41.969 0 82.484 0 124.608 0 0 19.109 0 37.41 0 57.676-40.679 0-81.185 0-124.608 0zM452.553 627.515c41.989 0 81.692 0 123.154 0 0 19.388 0 37.63 0 57.872-40.875 0-81.164 0-123.154 0 0-18.865 0-37.166 0-57.872zM797.657 557.428c-40.26 0-79.616 0-120.588 0 0-19.875 0-38.175 0-58.319 39.938 0 79.387 0 120.588 0 0 18.958 0 37.883 0 58.319zM798.429 628.406c0 19.756 0 37.445 0 57.029-40.335 0-79.737 0-121.068 0 0-18.958 0-37.206 0-57.029 40.609 0 80.698 0 121.068 0z" p-id="2043"></path></svg>
            <span><?php $this->date('Y.m.d'); ?></span>
            </span>
        </div>
     </div>
  </div>
</div>
<?php endwhile; ?>
<div class="paginator pager pagination" >
<div class="paginator_container pagination_container"><a class="btn pre newer-posts newer_posts"><?php $this->pageLink('返回上一页'); ?></a>
<a class="btn next older-posts older_posts"><?php $this->pageLink('阅读更多文章','next'); ?></a>
</div>
<div style="clear:both;height:0;"></div>
</div>
</div>
</div>
</div>
<?php $this->need('footer.php'); ?>
